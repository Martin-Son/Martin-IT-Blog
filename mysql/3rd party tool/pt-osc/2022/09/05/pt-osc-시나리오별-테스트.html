<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>pt-osc 동작 원리와 시나리오별 테스트 | Martin’s Study Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="pt-osc 동작 원리와 시나리오별 테스트" />
<meta name="author" content="Martin.S" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="pt-osc 툴을 사용하면서, 툴의 동작 방식과 여러 시나리오별로 어떻게 동작하는지 테스트해본 결과를 정리하려 합니다. 기본적인 내용들은 이전 포스트를 통해 정리하여 혹시 필요하신 내용이 있다면 아래 포스트를 참고 부탁드립니다. pt-osc의 설치 및 사용법 pt-osc 옵션 &amp; 작업 실패 시 절차" />
<meta property="og:description" content="pt-osc 툴을 사용하면서, 툴의 동작 방식과 여러 시나리오별로 어떻게 동작하는지 테스트해본 결과를 정리하려 합니다. 기본적인 내용들은 이전 포스트를 통해 정리하여 혹시 필요하신 내용이 있다면 아래 포스트를 참고 부탁드립니다. pt-osc의 설치 및 사용법 pt-osc 옵션 &amp; 작업 실패 시 절차" />
<link rel="canonical" href="https://martin-son.github.io/Martin-IT-Blog/mysql/3rd%20party%20tool/pt-osc/2022/09/05/pt-osc-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4%EB%B3%84-%ED%85%8C%EC%8A%A4%ED%8A%B8.html" />
<meta property="og:url" content="https://martin-son.github.io/Martin-IT-Blog/mysql/3rd%20party%20tool/pt-osc/2022/09/05/pt-osc-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4%EB%B3%84-%ED%85%8C%EC%8A%A4%ED%8A%B8.html" />
<meta property="og:site_name" content="Martin’s Study Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-05T18:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="pt-osc 동작 원리와 시나리오별 테스트" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Martin.S"},"dateModified":"2022-09-05T18:00:00-05:00","datePublished":"2022-09-05T18:00:00-05:00","description":"pt-osc 툴을 사용하면서, 툴의 동작 방식과 여러 시나리오별로 어떻게 동작하는지 테스트해본 결과를 정리하려 합니다. 기본적인 내용들은 이전 포스트를 통해 정리하여 혹시 필요하신 내용이 있다면 아래 포스트를 참고 부탁드립니다. pt-osc의 설치 및 사용법 pt-osc 옵션 &amp; 작업 실패 시 절차","headline":"pt-osc 동작 원리와 시나리오별 테스트","mainEntityOfPage":{"@type":"WebPage","@id":"https://martin-son.github.io/Martin-IT-Blog/mysql/3rd%20party%20tool/pt-osc/2022/09/05/pt-osc-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4%EB%B3%84-%ED%85%8C%EC%8A%A4%ED%8A%B8.html"},"url":"https://martin-son.github.io/Martin-IT-Blog/mysql/3rd%20party%20tool/pt-osc/2022/09/05/pt-osc-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4%EB%B3%84-%ED%85%8C%EC%8A%A4%ED%8A%B8.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/Martin-IT-Blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://martin-son.github.io/Martin-IT-Blog/feed.xml" title="Martin's Study Blog" /><link rel="shortcut icon" type="image/x-icon" href="/Martin-IT-Blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/Martin-IT-Blog/">Martin&#39;s Study Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/Martin-IT-Blog/about/">About Me</a><a class="page-link" href="/Martin-IT-Blog/gitInfo/">gitInfo</a><a class="page-link" href="/Martin-IT-Blog/search/">Search</a><a class="page-link" href="/Martin-IT-Blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">pt-osc 동작 원리와 시나리오별 테스트</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-09-05T18:00:00-05:00" itemprop="datePublished">
        Sep 5, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Martin.S</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      10 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/Martin-IT-Blog/categories/#MySQL">MySQL</a>
        &nbsp;
      
        <a class="category-tags-link" href="/Martin-IT-Blog/categories/#3rd party tool">3rd party tool</a>
        &nbsp;
      
        <a class="category-tags-link" href="/Martin-IT-Blog/categories/#pt-osc">pt-osc</a>
        
      
      </p>
    

    </header>

  
  <div class="post-content e-content" itemprop="articleBody">    
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#pt-osc-작업-시-general-log-확인">pt-osc 작업 시, general log 확인</a></li>
<li class="toc-entry toc-h2"><a href="#pt-osc-작업-도중-트리거-제거">pt-osc 작업 도중 트리거 제거</a></li>
<li class="toc-entry toc-h2"><a href="#트래픽-유무에-따른-작업-소요-시간-변경">트래픽 유무에 따른 작업 소요 시간 변경</a></li>
<li class="toc-entry toc-h2"><a href="#primary-key-unique-key-유무에-따른-제약">Primary Key, Unique Key 유무에 따른 제약</a></li>
</ul><p>pt-osc 툴을 사용하면서, 툴의 동작 방식과 여러 시나리오별로 어떻게 동작하는지 테스트해본 결과를 정리하려 합니다.
기본적인 내용들은 이전 포스트를 통해 정리하여 혹시 필요하신 내용이 있다면 아래 포스트를 참고 부탁드립니다.</p>
<ul>
  <li><a href="https://martin-son.github.io/Martin-IT-Blog/mysql/3rd%20party%20tool/pt-osc/2022/08/20/pt-osc-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%82%AC%EC%9A%A9%EB%B2%95.html">pt-osc의 설치 및 사용법</a></li>
  <li><a href="https://martin-son.github.io/Martin-IT-Blog/mysql/3rd%20party%20tool/pt-osc/2022/08/28/pt-osc-%EC%98%B5%EC%85%98-&amp;-%EC%9E%91%EC%97%85-%EC%8B%A4%ED%8C%A8-%EC%8B%9C-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4.html">pt-osc 옵션 &amp; 작업 실패 시 절차</a></li>
</ul>

<h2 id="pt-osc-작업-시-general-log-확인">
<a class="anchor" href="#pt-osc-%EC%9E%91%EC%97%85-%EC%8B%9C-general-log-%ED%99%95%EC%9D%B8" aria-hidden="true"><span class="octicon octicon-link"></span></a>pt-osc 작업 시, general log 확인</h2>
<p>pt-osc 작업 시, 어떤 쿼리가 들어오는지 확인하기 위해 General log를 통해 확인했습니다.</p>

<p>테스트 결과, pt-osc 작업으로 인해 실행되는 내부 쿼리는 아래 순서로 쿼리가 실행됐습니다.</p>
<ul>
  <li>set-vars 옵션을 통해 선언한 <strong>세션 변수 세팅</strong>
</li>
  <li>원본 테이블 스키마 추출 후, 작업 후 <strong>변경될 스키마와 동일한 테이블 생성</strong>
</li>
  <li>데이터 copy를 위한, <strong>트리거 생성</strong> (Insert, Update, Delete)</li>
  <li>다음 Chunk 범위 조건절에서 사용될 키 데이터 추출 (explain 포함)</li>
  <li>범위 조건절을 통해 chunk 사이즈만큼 타겟테이블로 데이터 copy (insert ignore into … select)</li>
</ul>

<p>general log를 통해 pt-osc 툴로 인해 실행되는 내부 쿼리를 확인할 수 있어,
테스트를 통해 작동원리를 이해하는데 도움이 됐습니다.</p>

<ol>
  <li>pt-osc 실행
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> pt-online-schema-change <span class="nt">--alter</span> <span class="s2">"[변경 내용]"</span> <span class="nv">D</span><span class="o">=[</span>데이터베이스명],t<span class="o">=[</span>테이블명] <span class="se">\ </span>
 <span class="nt">--host</span><span class="o">=[</span>호스트명] <span class="nt">--port</span><span class="o">=[</span>포트] <span class="se">\ </span>
 <span class="nt">--user</span><span class="o">=[</span>유저명] <span class="nt">--password</span><span class="o">=[</span>패스워드] <span class="se">\ </span>
 <span class="nt">--charset</span><span class="o">=</span>UTF8mb4 <span class="se">\ </span>
 <span class="nt">--analyze-before-swap</span> <span class="se">\ </span>                                                                    <span class="c">## swap 이전 타겟 테이블 통계 업데이트 (DEFAULT)</span>
 <span class="nt">--alter-foreign-keys-method</span><span class="o">=</span>auto <span class="se">\ </span>                                                         <span class="c">## 외래키 복사</span>
 <span class="nt">--chunk-index</span><span class="o">=</span>PRIMARY <span class="nt">--chunk-size</span><span class="o">=</span>1000 <span class="nt">--chunk-size-limit</span><span class="o">=</span>4.0 <span class="se">\ </span>                           <span class="c">## chunk 기준 설정</span>
 <span class="nt">--max-load</span><span class="o">=[</span>시간대 평균 트래픽에 따라 변동] <span class="se">\ </span>                                                     <span class="c">## 평소 대비 높은 트래픽일 경우, pt-osc 작업 일시 중지</span>
 <span class="nt">--no-drop-new-table</span> <span class="se">\ </span>                                                                      <span class="c">## 작업 중간 실패 시, 타겟테이블 보존 (DEFAULT = 삭제)</span>
 <span class="nt">--no-drop-old-table</span> <span class="se">\ </span>                                                                      <span class="c">## 기존 테이블 보존 (DEFAULT = 삭제)</span>
 <span class="nt">--progress</span><span class="o">=</span><span class="nb">time</span>,30 <span class="se">\ </span>                                                                       <span class="c">## 30초마다 로그 기록</span>
 <span class="nt">--swap-tables</span> <span class="se">\ </span>                                                                            <span class="c">## 테이블 스위칭  (DEFAULT)</span>
 <span class="nt">--set-vars</span><span class="o">=</span><span class="s2">"wait_timeout=60, lock_wait_timeout=3, innodb_lock_wait_timeout=3"</span> <span class="se">\ </span>            <span class="c">## pt-osc 작업으로 인한 lock 대기 시간이 너무 길어지지 않도록 설정</span>
 <span class="nt">--execute</span>
</code></pre></div>    </div>
  </li>
  <li>general log 확인
    <div class="language-sql highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c1">-- 세션 환경변수 Setting 값 선언</span>
 <span class="k">SET</span> <span class="k">SESSION</span> <span class="n">innodb_lock_wait_timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
 <span class="k">SET</span> <span class="k">SESSION</span> <span class="n">lock_wait_timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
 <span class="k">SET</span> <span class="k">SESSION</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">;</span>
    
 <span class="c1">-- 원본 테이블 스키마 정보 추출</span>
 <span class="k">SHOW</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`sbtest1`</span><span class="p">;</span>
 <span class="c1">-- 신규 테이블 스키마 생성</span>
 <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`_sbtest1_new`</span> <span class="p">(</span>
     <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
     <span class="nv">`k`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">'0'</span><span class="p">,</span>
     <span class="nv">`c`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
     <span class="nv">`pad`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
     <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">),</span>
     <span class="k">KEY</span> <span class="nv">`k_1`</span> <span class="p">(</span><span class="nv">`k`</span><span class="p">)</span>
     <span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">30000001</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="p">;</span>
        
 <span class="c1">-- 트리거 존재 확인</span>
 <span class="k">SELECT</span> <span class="k">TRIGGER_SCHEMA</span><span class="p">,</span> <span class="k">TRIGGER_NAME</span><span class="p">,</span> <span class="k">DEFINER</span><span class="p">,</span> <span class="n">ACTION_STATEMENT</span><span class="p">,</span> <span class="n">SQL_MODE</span><span class="p">,</span> <span class="n">CHARACTER_SET_CLIENT</span><span class="p">,</span> <span class="n">COLLATION_CONNECTION</span><span class="p">,</span> <span class="n">EVENT_MANIPULATION</span><span class="p">,</span> <span class="n">ACTION_TIMING</span> <span class="k">FROM</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">TRIGGERS</span> <span class="k">WHERE</span> <span class="n">EVENT_MANIPULATION</span> <span class="o">=</span> <span class="s1">'DELETE'</span> <span class="k">AND</span> <span class="n">ACTION_TIMING</span> <span class="o">=</span> <span class="s1">'AFTER'</span> <span class="k">AND</span> <span class="k">TRIGGER_SCHEMA</span> <span class="o">=</span> <span class="s1">'sbtest_220822'</span> <span class="k">AND</span> <span class="n">EVENT_OBJECT_TABLE</span> <span class="o">=</span> <span class="s1">'sbtest1'</span><span class="p">;</span>
    
 <span class="k">SELECT</span> <span class="k">TRIGGER_SCHEMA</span><span class="p">,</span> <span class="k">TRIGGER_NAME</span><span class="p">,</span> <span class="k">DEFINER</span><span class="p">,</span> <span class="n">ACTION_STATEMENT</span><span class="p">,</span> <span class="n">SQL_MODE</span><span class="p">,</span> <span class="n">CHARACTER_SET_CLIENT</span><span class="p">,</span> <span class="n">COLLATION_CONNECTION</span><span class="p">,</span> <span class="n">EVENT_MANIPULATION</span><span class="p">,</span> <span class="n">ACTION_TIMING</span> <span class="k">FROM</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">TRIGGERS</span> <span class="k">WHERE</span> <span class="n">EVENT_MANIPULATION</span> <span class="o">=</span> <span class="s1">'UPDATE'</span> <span class="k">AND</span> <span class="n">ACTION_TIMING</span> <span class="o">=</span> <span class="s1">'AFTER'</span> <span class="k">AND</span> <span class="k">TRIGGER_SCHEMA</span> <span class="o">=</span> <span class="s1">'sbtest_220822'</span> <span class="k">AND</span> <span class="n">EVENT_OBJECT_TABLE</span> <span class="o">=</span> <span class="s1">'sbtest1'</span><span class="p">;</span>
    
 <span class="k">SELECT</span> <span class="k">TRIGGER_SCHEMA</span><span class="p">,</span> <span class="k">TRIGGER_NAME</span><span class="p">,</span> <span class="k">DEFINER</span><span class="p">,</span> <span class="n">ACTION_STATEMENT</span><span class="p">,</span> <span class="n">SQL_MODE</span><span class="p">,</span> <span class="n">CHARACTER_SET_CLIENT</span><span class="p">,</span> <span class="n">COLLATION_CONNECTION</span><span class="p">,</span> <span class="n">EVENT_MANIPULATION</span><span class="p">,</span> <span class="n">ACTION_TIMING</span> <span class="k">FROM</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">TRIGGERS</span> <span class="k">WHERE</span> <span class="n">EVENT_MANIPULATION</span> <span class="o">=</span> <span class="s1">'INSERT'</span> <span class="k">AND</span> <span class="n">ACTION_TIMING</span> <span class="o">=</span> <span class="s1">'AFTER'</span> <span class="k">AND</span> <span class="k">TRIGGER_SCHEMA</span> <span class="o">=</span> <span class="s1">'sbtest_220822'</span> <span class="k">AND</span> <span class="n">EVENT_OBJECT_TABLE</span> <span class="o">=</span> <span class="s1">'sbtest1'</span><span class="p">;</span>
    
 <span class="c1">-- 트리거 생성</span>
 <span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="nv">`pt_osc_sbtest_220822_sbtest1_del`</span> <span class="k">AFTER</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`sbtest1`</span> <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">DELETE</span> <span class="k">IGNORE</span> <span class="k">FROM</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`_sbtest1_new`</span> <span class="k">WHERE</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`_sbtest1_new`</span><span class="p">.</span><span class="nv">`id`</span> <span class="o">&lt;=&gt;</span> <span class="k">OLD</span><span class="p">.</span><span class="nv">`id`</span><span class="p">;</span>
 <span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="nv">`pt_osc_sbtest_220822_sbtest1_upd`</span> <span class="k">AFTER</span> <span class="k">UPDATE</span> <span class="k">ON</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`sbtest1`</span> <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">BEGIN</span> <span class="k">DELETE</span> <span class="k">IGNORE</span> <span class="k">FROM</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`_sbtest1_new`</span> <span class="k">WHERE</span> <span class="o">!</span><span class="p">(</span><span class="k">OLD</span><span class="p">.</span><span class="nv">`id`</span> <span class="o">&lt;=&gt;</span> <span class="k">NEW</span><span class="p">.</span><span class="nv">`id`</span><span class="p">)</span> <span class="k">AND</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`_sbtest1_new`</span><span class="p">.</span><span class="nv">`id`</span> <span class="o">&lt;=&gt;</span> <span class="k">OLD</span><span class="p">.</span><span class="nv">`id`</span><span class="p">;</span><span class="k">REPLACE</span> <span class="k">INTO</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`_sbtest1_new`</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span> <span class="nv">`k`</span><span class="p">,</span> <span class="nv">`c`</span><span class="p">,</span> <span class="nv">`pad`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="nv">`id`</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="nv">`k`</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="nv">`c`</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="nv">`pad`</span><span class="p">);</span><span class="k">END</span><span class="p">;</span>
 <span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="nv">`pt_osc_sbtest_220822_sbtest1_ins`</span> <span class="k">AFTER</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`sbtest1`</span> <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">REPLACE</span> <span class="k">INTO</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`_sbtest1_new`</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span> <span class="nv">`k`</span><span class="p">,</span> <span class="nv">`c`</span><span class="p">,</span> <span class="nv">`pad`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="nv">`id`</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="nv">`k`</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="nv">`c`</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="nv">`pad`</span><span class="p">);</span>
    
 <span class="p">.....</span>
 <span class="p">.....</span>
 <span class="p">.....</span>
    
 <span class="c1">-- 다음 Chunk 범위 체크 쿼리 실행 계획 확인</span>
 <span class="k">EXPLAIN</span> <span class="k">SELECT</span> <span class="cm">/*!40001 SQL_NO_CACHE */</span> <span class="nv">`id`</span> <span class="k">FROM</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`sbtest1`</span> <span class="k">FORCE</span> <span class="k">INDEX</span><span class="p">(</span><span class="nv">`PRIMARY`</span><span class="p">)</span> <span class="k">WHERE</span> <span class="p">((</span><span class="nv">`id`</span> <span class="o">&gt;=</span> <span class="s1">'5001'</span><span class="p">))</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">`id`</span> <span class="k">LIMIT</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">2</span> <span class="cm">/*next chunk boundary*/</span><span class="p">;</span>
    
 <span class="c1">-- 다음 Chunk 범위 id 값 추출</span>
 <span class="k">SELECT</span> <span class="cm">/*!40001 SQL_NO_CACHE */</span> <span class="nv">`id`</span> <span class="k">FROM</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`sbtest1`</span> <span class="k">FORCE</span> <span class="k">INDEX</span><span class="p">(</span><span class="nv">`PRIMARY`</span><span class="p">)</span> <span class="k">WHERE</span> <span class="p">((</span><span class="nv">`id`</span> <span class="o">&gt;=</span> <span class="s1">'5001'</span><span class="p">))</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">`id`</span> <span class="k">LIMIT</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">2</span> <span class="cm">/*next chunk boundary*/</span><span class="p">;</span>
    
 <span class="c1">-- Chunk 범위에 따른 조회 쿼리 실행 계획 확인</span>
 <span class="k">EXPLAIN</span> <span class="k">SELECT</span> <span class="nv">`id`</span><span class="p">,</span> <span class="nv">`k`</span><span class="p">,</span> <span class="nv">`c`</span><span class="p">,</span> <span class="nv">`pad`</span> <span class="k">FROM</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`sbtest1`</span> <span class="k">FORCE</span> <span class="k">INDEX</span><span class="p">(</span><span class="nv">`PRIMARY`</span><span class="p">)</span> <span class="k">WHERE</span> <span class="p">((</span><span class="nv">`id`</span> <span class="o">&gt;=</span> <span class="s1">'5001'</span><span class="p">))</span> <span class="k">AND</span> <span class="p">((</span><span class="nv">`id`</span> <span class="o">&lt;=</span> <span class="s1">'6000'</span><span class="p">))</span> <span class="k">LOCK</span> <span class="k">IN</span> <span class="k">SHARE</span> <span class="k">MODE</span> <span class="cm">/*explain pt-online-schema-change 20652 copy nibble*/</span><span class="p">;</span>
    
 <span class="c1">-- Chunk 범위 데이터 Copy</span>
 <span class="k">INSERT</span> <span class="n">LOW_PRIORITY</span> <span class="k">IGNORE</span> <span class="k">INTO</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`_sbtest1_new`</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span> <span class="nv">`k`</span><span class="p">,</span> <span class="nv">`c`</span><span class="p">,</span> <span class="nv">`pad`</span><span class="p">)</span> <span class="k">SELECT</span> <span class="nv">`id`</span><span class="p">,</span> <span class="nv">`k`</span><span class="p">,</span> <span class="nv">`c`</span><span class="p">,</span> <span class="nv">`pad`</span> <span class="k">FROM</span> <span class="nv">`sbtest_220822`</span><span class="p">.</span><span class="nv">`sbtest1`</span> <span class="k">FORCE</span> <span class="k">INDEX</span><span class="p">(</span><span class="nv">`PRIMARY`</span><span class="p">)</span> <span class="k">WHERE</span> <span class="p">((</span><span class="nv">`id`</span> <span class="o">&gt;=</span> <span class="s1">'5001'</span><span class="p">))</span> <span class="k">AND</span> <span class="p">((</span><span class="nv">`id`</span> <span class="o">&lt;=</span> <span class="s1">'6000'</span><span class="p">))</span> <span class="k">LOCK</span> <span class="k">IN</span> <span class="k">SHARE</span> <span class="k">MODE</span> <span class="cm">/*pt-online-schema-change 20652 copy nibble*/</span><span class="p">;</span>
    
 <span class="c1">-- 청크 작업별 Thread Running 수 체크 (--max-load="Running_Thread=25") 확인</span>
 <span class="k">SHOW</span> <span class="k">GLOBAL</span> <span class="n">STATUS</span> <span class="k">LIKE</span> <span class="s1">'Threads_running'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="pt-osc-작업-도중-트리거-제거">
<a class="anchor" href="#pt-osc-%EC%9E%91%EC%97%85-%EB%8F%84%EC%A4%91-%ED%8A%B8%EB%A6%AC%EA%B1%B0-%EC%A0%9C%EA%B1%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>pt-osc 작업 도중 트리거 제거</h2>
<p>실제로 운영 중에 발생할 확률은 극히 적지만, 만약 실시간 data 동기화를 위해 생성된 trigger를 삭제하면
어떤 문제가 발생할 지 테스트를 진행했습니다.</p>

<p>테스트 결과, 원본과 타겟테이블 사이에 3000만건의 데이터 중 <strong>약 5300건의 데이터 틀어짐</strong>이 발생했습니다.
트리거가 삭제되지 않도록 주의가 필요하다는 사실을 직접 확인했습니다.</p>

<ol>
  <li>백그라운드로 pt-osc 실행
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">nohup </span>pt-online-schema-change <span class="nt">--alter</span> <span class="s2">"CHANGE c c varchar(120) DEFAULT '' NOT NULL"</span> <span class="nv">D</span><span class="o">=</span>sbtest_220822,t<span class="o">=</span>sbtest1 <span class="se">\ </span>
 <span class="nt">--no-drop-old-table</span> <span class="nt">--chunk-size</span><span class="o">=</span>1000 <span class="nt">--chunk-index</span><span class="o">=</span>PRIMARY <span class="se">\ </span>
 <span class="nt">--host</span><span class="o">=[</span>호스트 정보] <span class="se">\ </span>
 <span class="nt">--port</span><span class="o">=</span>6025 <span class="se">\ </span>
 <span class="nt">--user</span><span class="o">=[</span>DB 계정 정보] <span class="se">\ </span>
 <span class="nt">--password</span><span class="o">=[</span>DB 패스워드] <span class="nt">--progress</span><span class="o">=</span><span class="nb">time</span>,30 <span class="nt">--charset</span><span class="o">=</span>UTF8mb4 <span class="se">\ </span>
 <span class="nt">--max-load</span><span class="o">=</span><span class="s2">"Threads_running=25"</span> <span class="se">\ </span>
 <span class="nt">--alter-foreign-keys-method</span><span class="o">=</span>auto  <span class="nt">--execute</span> &amp;
</code></pre></div>    </div>
  </li>
  <li>작업 진행 중, 트리거 제거
    <div class="language-sql highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="n">mysql</span><span class="o">&gt;</span> <span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="n">pt_osc_sbtest_220822_sbtest1_ins</span><span class="p">;</span>
 <span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">04</span> <span class="n">sec</span><span class="p">)</span>
    
 <span class="n">mysql</span><span class="o">&gt;</span> <span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="n">pt_osc_sbtest_220822_sbtest1_upd</span><span class="p">;</span>
 <span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span> <span class="n">sec</span><span class="p">)</span>
    
 <span class="n">mysql</span><span class="o">&gt;</span> <span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="n">pt_osc_sbtest_220822_sbtest1_del</span><span class="p">;</span>
 <span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>sysbench를 이용한 원본 테이블 트래픽 구성 (DML)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="o">[</span><span class="nv">$PATH</span><span class="o">]</span>/sysbench <span class="se">\ </span>
 <span class="o">[</span><span class="nv">$PATH</span><span class="o">]</span>/sysbench/oltp_read_write.lua <span class="se">\ </span>
 <span class="nt">--mysql-host</span><span class="o">=</span><span class="s1">'[host 정보]'</span> <span class="se">\ </span>
 <span class="nt">--mysql-port</span><span class="o">=[</span>Port 정보] <span class="nt">--mysql-user</span><span class="o">=[</span>DB 계정 정보] <span class="nt">--mysql-password</span><span class="o">=[</span>DB 패스워드] <span class="nt">--mysql-db</span><span class="o">=</span>sbtest_220822 <span class="se">\ </span>
 <span class="nt">--db-driver</span><span class="o">=</span>mysql <span class="nt">--threads</span><span class="o">=</span>16 <span class="nt">--time</span><span class="o">=</span>1200 <span class="nt">--forced-shutdown</span> <span class="nt">--report-interval</span><span class="o">=</span>1 run
</code></pre></div>    </div>
  </li>
  <li>sysbench 실행 확인
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> mysql&gt; show processlist<span class="p">;</span>
 +---------+----------+-------------------+---------------+---------+------+-----------------------------+------------------------------------------------------------------------------------------------------+
 | Id      | User     | Host              | db            | Command | Time | State                       | Info                                                                                                 |
 +---------+----------+-------------------+---------------+---------+------+-----------------------------+------------------------------------------------------------------------------------------------------+
 | 1761661 | master   | 10.81.20.86:59136 | sbtest_220822 | Query   |    0 | statistics                  | EXPLAIN SELECT /<span class="k">*</span><span class="o">!</span>40001 SQL_NO_CACHE <span class="k">*</span>/ <span class="sb">`</span><span class="nb">id</span><span class="sb">`</span> FROM <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span> FORCE INDEX<span class="o">(</span><span class="sb">`</span>PRIMARY<span class="sb">`</span><span class="o">)</span> W |
 | 1761662 | master   | 10.81.20.86:59138 | sbtest_220822 | Sleep   |  532 | NULL                        | NULL                                                                                                 |
 | 1761717 | master   | 172.27.1.29:54616 | NULL          | Query   |    0 | starting                    | show processlist                                                                                     |
 | 1761739 | master   | 10.81.20.86:59254 | sbtest_220822 | Execute |    0 | updating                    | DELETE FROM sbtest1 WHERE <span class="nb">id</span><span class="o">=</span>5050                                                                    |
 | 1761740 | master   | 10.81.20.86:59256 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 | 1761741 | master   | 10.81.20.86:59260 | sbtest_220822 | Execute |    0 | updating                    | UPDATE sbtest1 SET <span class="nv">k</span><span class="o">=</span>k+1 WHERE <span class="nb">id</span><span class="o">=</span>5040                                                               |
 | 1761742 | master   | 10.81.20.86:59258 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 | 1761743 | master   | 10.81.20.86:59262 | sbtest_220822 | Execute |    0 | starting                    | COMMIT                                                                                               |
 | 1761744 | master   | 10.81.20.86:59264 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 | 1761745 | master   | 10.81.20.86:59266 | sbtest_220822 | Execute |    0 | Sending data                | SELECT DISTINCT c FROM sbtest1 WHERE <span class="nb">id </span>BETWEEN 5038 AND 5137 ORDER BY c                             |
 | 1761746 | master   | 10.81.20.86:59268 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 | 1761747 | master   | 10.81.20.86:59270 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 | 1761748 | master   | 10.81.20.86:59272 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 | 1761749 | master   | 10.81.20.86:59274 | sbtest_220822 | Sleep   |    0 | NULL                        | NULL                                                                                                 |
 | 1761750 | master   | 10.81.20.86:59278 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 | 1761751 | master   | 10.81.20.86:59276 | sbtest_220822 | Execute |    0 | updating                    | DELETE FROM sbtest1 WHERE <span class="nb">id</span><span class="o">=</span>5050                                                                    |
 | 1761752 | master   | 10.81.20.86:59280 | sbtest_220822 | Execute |    0 | updating                    | UPDATE sbtest1 SET <span class="nv">c</span><span class="o">=</span><span class="s1">'49383389871-28759029460-46414709084-42859700036-88535704466-45735151440-305043'</span> |
 | 1761753 | master   | 10.81.20.86:59282 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 | 1761754 | master   | 10.81.20.86:59284 | sbtest_220822 | Execute |    0 | delayed commit ok initiated | COMMIT                                                                                               |
 +---------+----------+-------------------+---------------+---------+------+-----------------------------+------------------------------------------------------------------------------------------------------+
</code></pre></div>    </div>
  </li>
  <li>작업 종료 후 데이터 틀어짐 확인
    <div class="language-sql highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">sbtest1</span> <span class="k">AS</span> <span class="n">A</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">____sbtest1_old</span> <span class="k">AS</span> <span class="n">B</span> <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">id</span> <span class="k">WHERE</span> <span class="n">A</span><span class="p">.</span><span class="n">k</span> <span class="o">&lt;&gt;</span> <span class="n">B</span><span class="p">.</span><span class="n">k</span><span class="p">;</span>
 <span class="o">+</span><span class="c1">----------+</span>
 <span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
 <span class="o">+</span><span class="c1">----------+</span>
 <span class="o">|</span>     <span class="mi">5295</span> <span class="o">|</span>
 <span class="o">+</span><span class="c1">----------+</span>
 <span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">14</span> <span class="k">min</span> <span class="mi">24</span><span class="p">.</span><span class="mi">14</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="트래픽-유무에-따른-작업-소요-시간-변경">
<a class="anchor" href="#%ED%8A%B8%EB%9E%98%ED%94%BD-%EC%9C%A0%EB%AC%B4%EC%97%90-%EB%94%B0%EB%A5%B8-%EC%9E%91%EC%97%85-%EC%86%8C%EC%9A%94-%EC%8B%9C%EA%B0%84-%EB%B3%80%EA%B2%BD" aria-hidden="true"><span class="octicon octicon-link"></span></a>트래픽 유무에 따른 작업 소요 시간 변경</h2>
<p>pt-osc 작업 시, mysql 통계에 저장된 테이블 Rows를 기반으로 작업 소요 시간을 예측하여 알려줍니다.</p>

<p>아무런 부하 없이 작업하게 되면 예상 소요시간이 크게 달라지지 않지만,
테스트를 통해 중간에 높은 트래픽을 걸어 예상 소요시간이 크게 변동되는걸 확인할 수 있었습니다.</p>

<p>예상 소요 시간은 어디까지나 <strong>불확실한 참고 데이터</strong>이며 트래픽이 높은 서비스 환경에서는
해당 시간의 <strong>부정확도가 더욱 커질 수 있다</strong>는 점을 작업 시 유의해야 합니다.</p>

<ol>
  <li>pt-osc 실행
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="c">## pt-osc 실행</span>
 <span class="nv">$ </span><span class="nb">nohup </span>pt-online-schema-change <span class="nt">--alter</span> <span class="s2">"CHANGE c c varchar(120) DEFAULT '' NOT NULL"</span> <span class="nv">D</span><span class="o">=</span>sbtest_220822,t<span class="o">=</span>sbtest1 <span class="se">\ </span>
 <span class="nt">--no-drop-old-table</span> <span class="se">\ </span>
 <span class="nt">--chunk-size</span><span class="o">=</span>1000 <span class="nt">--chunk-index</span><span class="o">=</span>PRIMARY <span class="se">\ </span>
 <span class="nt">--host</span><span class="o">=[</span>호스트 정보] <span class="nt">--port</span><span class="o">=[</span>포트 정보] <span class="se">\ </span>
 <span class="nt">--user</span><span class="o">=[</span>DB 계정 정보] <span class="se">\ </span>
 <span class="nt">--password</span><span class="o">=[</span>DB 패스워드] <span class="se">\ </span>
 <span class="nt">--progress</span><span class="o">=</span><span class="nb">time</span>,30 <span class="se">\ </span>
 <span class="nt">--charset</span><span class="o">=</span>UTF8mb4 <span class="se">\ </span>
 <span class="nt">--max-load</span><span class="o">=</span><span class="s2">"Threads_running=100"</span> <span class="nt">--critical-load</span><span class="o">=</span><span class="s2">"Threads_running=200"</span> <span class="se">\ </span>
 <span class="nt">--alter-foreign-keys-method</span><span class="o">=</span>auto <span class="se">\</span>
 <span class="nt">--execute</span> <span class="o">&gt;</span> <span class="o">[</span><span class="nv">$PATH</span><span class="o">]</span>/traffic_test.txt 2&gt;&amp;1 &amp;
</code></pre></div>    </div>
  </li>
  <li>pt-osc 작업 중간중간 sysbench를 활용해 부하 생성
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> /usr/local/sysbench/bin/sysbench <span class="se">\ </span>
 /usr/local/sysbench/oltp_read_write.lua <span class="se">\ </span>
 <span class="nt">--mysql-host</span><span class="o">=[</span>호스트 정보] <span class="se">\ </span>
 <span class="nt">--mysql-port</span><span class="o">=[</span>포트 정보] <span class="se">\ </span>
 <span class="nt">--mysql-user</span><span class="o">=[</span>DB 계정 정보] <span class="nt">--mysql-password</span><span class="o">=[</span>DB 패스워드] <span class="se">\ </span>
 <span class="nt">--mysql-db</span><span class="o">=</span>sbtest_220822 <span class="se">\ </span>
 <span class="nt">--db-driver</span><span class="o">=</span>mysql <span class="nt">--threads</span><span class="o">=</span>32 <span class="nt">--time</span><span class="o">=</span>1200 <span class="nt">--forced-shutdown</span> <span class="nt">--report-interval</span><span class="o">=</span>1 run
</code></pre></div>    </div>
  </li>
</ol>

<p>traffic_test 로그 파일을 살펴보면 트래픽을 발생시킨 시간대마다,예측 소요시간이 3배 증가했다가 감소되는 현상을 확인할 수 있습니다.
이를 통해 <strong>트래픽에 따라, 예측 소요시간이 실시간으로 변동</strong>된다는 것을 알 수 있습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Creating new table...
Created new table sbtest_220822._sbtest1_new OK.
Altering new table...
Altered <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>_sbtest1_new<span class="sb">`</span> OK.
2022-08-23T01:30:22 Creating triggers...
2022-08-23T01:30:22 Created triggers OK.
2022-08-23T01:30:22 Copying approximately 29470326 rows...
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   1% 28:16 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   3% 28:26 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   3% 39:23 remain                   
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   3% 48:46 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   4% 57:06 remain                   
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   4% 01:03:49 remain            
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   4% 01:10:20 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   4% 01:16:14 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   5% 01:21:23 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   5% 01:26:10 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   5% 01:30:24 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   6% 01:33:40 remain                 <span class="c">### 부하 발생으로 인한 소요시간 증가 (28분 -&gt; 1시간 33분)</span>
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   7% 01:17:42 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:   9% 01:07:42 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  11% 01:00:17 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  12% 54:48 remain                    <span class="c">### 부하 제거로 30초당, 예상 소요시간 빠르게 감소</span>
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  14% 50:28 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  16% 47:14 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  17% 44:37 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  19% 42:29 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  20% 40:30 remain                   
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  22% 38:50 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  23% 37:14 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  25% 35:52 remain
Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest1<span class="sb">`</span>:  26% 34:33 remain
</code></pre></div></div>

<h2 id="primary-key-unique-key-유무에-따른-제약">
<a class="anchor" href="#primary-key-unique-key-%EC%9C%A0%EB%AC%B4%EC%97%90-%EB%94%B0%EB%A5%B8-%EC%A0%9C%EC%95%BD" aria-hidden="true"><span class="octicon octicon-link"></span></a>Primary Key, Unique Key 유무에 따른 제약</h2>
<p>pt-osc툴을 사용하기 위해선, PK / UK 유무에 따른 제약 조건이 있다고 알고는 있지만,
서비스 환경에서 사용하는 테이블에, PK가 없는 경우는 찾기 어려워 제약조건을 제대로 파악하지는 못해 테스트를 진행했습니다.</p>

<p>PK, UK 유무에 따라 케이스를 나누어 pt-osc 툴이 정상 작동하는지 확인해본 결과입니다.</p>

<p>Prmary Key 또는 Unique Key가 테이블에 최소한 하나 존재해야 정상적으로 툴이 동작했으며,
위 조건을 만족하는 경우, chunk 기준을 일반 인덱스로 설정해도 작업이 가능했습니다.</p>

<table>
  <thead>
    <tr>
      <th>-</th>
      <th>Case 1</th>
      <th>Case 2</th>
      <th>Case 3</th>
      <th>Case 4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Primary Key</strong></td>
      <td>X</td>
      <td>X</td>
      <td>X</td>
      <td>X</td>
    </tr>
    <tr>
      <td><strong>Unique Key</strong></td>
      <td>X</td>
      <td>X</td>
      <td>O</td>
      <td>O</td>
    </tr>
    <tr>
      <td><strong>인덱스 유무</strong></td>
      <td>X</td>
      <td>O</td>
      <td>X</td>
      <td>O</td>
    </tr>
    <tr>
      <td><strong>정상 작동 여부</strong></td>
      <td>X</td>
      <td>X</td>
      <td>O</td>
      <td>O</td>
    </tr>
  </tbody>
</table>

<p>케이스에 따른 로그 결과는 다음과 같습니다.</p>

<ul>
  <li>Case 1 (PK x / UK x / 인덱스 X)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="c"># A software update is available:</span>
  Cannot chunk the original table <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>: There is no good index and the table is oversized. at /usr/local/bin/pt-online-schema-change line 5882.
</code></pre></div>    </div>
  </li>
  <li>Case 2 (PK x / UK x / 인덱스 O)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  Altering new table...
  Altered <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>_sbtest_no_pk_new<span class="sb">`</span> OK.
  2022-08-26T00:15:59 Dropping new table...
  2022-08-26T00:15:59 Dropped new table OK.
  <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span> was not altered.
  The new table <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>_sbtest_no_pk_new<span class="sb">`</span> does not have a PRIMARY KEY or a unique index which is required <span class="k">for </span>the DELETE trigger.
  Please check you have at least one UNIQUE and NOT NULLABLE index.
</code></pre></div>    </div>
  </li>
  <li>Case 3 (PK x / UK O)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  Altering <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>...
  Creating new table...
  Created new table sbtest_220822._sbtest_no_pk_new OK.
  Altering new table...
  Altered <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>_sbtest_no_pk_new<span class="sb">`</span> OK.
  2022-08-26T01:07:50 Creating triggers...
  2022-08-26T01:07:50 Created triggers OK.
  2022-08-26T01:07:50 Copying approximately 29589048 rows...
  Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>:   2% 19:19 remain
  Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>:   5% 18:40 remain
  Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>:   7% 18:49 remain
  Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>:   9% 18:31 remain
</code></pre></div>    </div>
  </li>
  <li>Case 4 (PK x / UK O / 인덱스 X / chunk 기준: 인덱스)
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> Altering <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>...
 Creating new table...
 Created new table sbtest_220822._sbtest_no_pk_new OK.
 Altering new table...
 Altered <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>_sbtest_no_pk_new<span class="sb">`</span> OK.
 2022-08-26T05:38:07 Creating triggers...
 2022-08-26T05:38:07 Created triggers OK.
 2022-08-26T05:38:07 Copying approximately 29470326 rows...
 Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>:   0% 01:46:22 remain
 Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>:   1% 01:36:37 remain
 Copying <span class="sb">`</span>sbtest_220822<span class="sb">`</span>.<span class="sb">`</span>sbtest_no_pk<span class="sb">`</span>:   1% 01:25:53 remain
</code></pre></div>    </div>
  </li>
</ul>


  </div><!-- from https://github.com/utterance/utterances
<script src="https://utteranc.es/client.js"
        repo="Martin-Son/Martin-IT-Blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>  -->

<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://martin-it-study-blog.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="u-url" href="/Martin-IT-Blog/mysql/3rd%20party%20tool/pt-osc/2022/09/05/pt-osc-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4%EB%B3%84-%ED%85%8C%EC%8A%A4%ED%8A%B8.html" hidden></a>
</article>

<script>
  function getTOCNodes(master) {
    var nodes = Array.prototype.slice.call(master.getElementsByTagName("*"), 0);
    var tocNodes = nodes.filter(function(elem) {
        return elem.tagName == "A";
    });
    return tocNodes;
  }
  function getHeaderNodes(master) {
    var nodes = Array.prototype.slice.call(master.getElementsByTagName("*"), 0);
    var headerNodes = nodes.filter(function(elem) {
        return elem.tagName == "H1" || elem.tagName == "H2" || elem.tagName == "H3" || elem.tagName == "H4" || elem.tagName == "H5" || elem.tagName == "H6";
    });
    return headerNodes;
  }

  var title = document.getElementsByClassName("post-title")[0];
  var titleY = window.pageYOffset + title.getBoundingClientRect().top;
  
  var article = document.getElementsByClassName("post-article")[0];
  var articleY = window.pageYOffset + article.getBoundingClientRect().top;

  var toc = document.getElementsByClassName("toc")[0];

  var headerNodes = getHeaderNodes(article);
  var tocNodes = getTOCNodes(toc);

  var before = undefined;

  document.addEventListener('scroll', function(e) {
    if (window.scrollY >= articleY-60) {
      toc.style.cssText = "position: fixed; top: 60px;";
    }
    else {
      toc.style.cssText = "";
    }

    var current = headerNodes.filter(function(header) {
      var headerY = window.pageYOffset + header.getBoundingClientRect().top;
      return window.scrollY >= headerY - 60;
    });

    if (current.length > 0) {
      current = current[current.length-1];

      var currentA = tocNodes.filter(function(tocNode) {
        return tocNode.innerHTML == current.innerHTML;
      })
      
      currentA = currentA[0];
      if (currentA) {
        if (before == undefined) before = currentA;

        if (before != currentA) {
          before.classList.remove("toc-active");
          before = currentA;
        }

        currentA.classList.add("toc-active");
      }
      else {
        if (before) 
          before.classList.remove("toc-active");
      }
    }
    else {
      if (before) 
          before.classList.remove("toc-active");
    }

  }, false);
</script>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/Martin-IT-Blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/Martin-IT-Blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/Martin-IT-Blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An easy to use blogging platform with support for Jupyter Notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/https%3A%2F%2Fgithub.com%2FMartin-Son%2FMartin-IT-Blog" target="_blank" title="https://github.com/Martin-Son/Martin-IT-Blog"><svg class="svg-icon grey"><use xlink:href="/Martin-IT-Blog/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
